<div id="search-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true">
    <div class="fixed inset-x-0 top-0 p-4 md:p-8 flex justify-center">
        <div class="relative w-full max-w-3xl">
            <div
                class="rounded-xl bg-white shadow-2xl ring-1 ring-gray-900/5 dark:bg-gray-900 dark:ring-white/10 flex flex-col max-h-[90vh]">

                <!-- Search Header -->
                <div class="flex items-center gap-4 px-4 py-3">
                    <div id="search" class="flex-1"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        // Event listeners should be attached regardless of Pagefind success
        const searchModal = document.getElementById('search-modal');
        const openBtn = document.getElementById('open-search');
        const mobileOpenBtn = document.getElementById('mobile-search-btn');
        let pagefindInit = false;

        function openSearch() {
            searchModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Try to focus input if available
            const searchInput = document.querySelector('.pagefind-ui__search-input');
            if (searchInput) {
                setTimeout(() => searchInput.focus(), 100);
            }

            if (!pagefindInit) {
                console.warn("PagefindUI not initialized yet. Ensure you've run 'bun run build' or are serving the 'public' directory correctly.");
            }
        }

        if (openBtn) openBtn.addEventListener('click', openSearch);
        if (mobileOpenBtn) {
            mobileOpenBtn.addEventListener('click', () => {
                openSearch();
                const sidebar = document.getElementById('sidebar');
                if (sidebar && !sidebar.classList.contains('hidden')) {
                    const menuClose = document.getElementById('menu-close');
                    if (menuClose) menuClose.click();
                }
            });
        }

        const mobileSearchLogoBtn = document.getElementById('mobile-search-logo-btn');
        if (mobileSearchLogoBtn) {
            mobileSearchLogoBtn.addEventListener('click', () => {
                openSearch();
                const sidebar = document.getElementById('sidebar');
                if (sidebar && !sidebar.classList.contains('hidden')) {
                    const menuClose = document.getElementById('menu-close');
                    if (menuClose) menuClose.click();
                }
            });
        }



        if (searchModal) {
            searchModal.addEventListener('click', (e) => {
                const contentBox = document.querySelector('#search-modal > div > div');
                if (contentBox && !contentBox.contains(e.target)) {
                    searchModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchModal && !searchModal.classList.contains('hidden')) {
                searchModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });

        // Initialize Pagefind
        try {
            if (typeof PagefindUI !== 'undefined') {
                new PagefindUI({
                    element: "#search",
                    showSubResults: true,
                    showImages: false,
                    translations: {
                        placeholder: "Search for posts..."
                    }
                });
                pagefindInit = true;
            } else {
                console.error("PagefindUI class not found. Make sure pagefind-ui.js is loaded.");
                const searchDiv = document.getElementById('search');
                if (searchDiv) searchDiv.innerHTML = '<p class="text-red-500 p-4">Search index not found. Please run build command.</p>';
            }
        } catch (e) {
            console.error("Failed to initialize Pagefind:", e);
        }
    });
</script>

<style>
    /* Custom Pagefind Overrides for Tailwind dark mode mainly */
    :root {
        --pagefind-ui-scale: 1;
        --pagefind-ui-primary: #3b82f6;
        --pagefind-ui-text: #979fac;
        --pagefind-ui-background: #ffffff;
        --pagefind-ui-border: #e5e7eb;
        --pagefind-ui-tag: #f3f4f6;
        --pagefind-ui-border-width: 1px;
        --pagefind-ui-border-radius: 0.5rem;
        --pagefind-ui-image-border-radius: 0.5rem;
        --pagefind-ui-image-box-ratio: 3 / 2;
        --pagefind-ui-font: inherit;
    }

    [data-theme="dark"] {
        --pagefind-ui-primary: #60a5fa;
        --pagefind-ui-text: #e5e7eb;
        --pagefind-ui-background: #111827;
        --pagefind-ui-border: #374151;
        --pagefind-ui-tag: #1f2937;
    }

    /* Remove bottom border from last result */
    .pagefind-ui__result:last-of-type {
        border-bottom: none !important;
    }

    /* Force placeholder and icon to be black */
    .pagefind-ui__search-input::placeholder {
        color: #000000 !important;
        opacity: 0.7 !important;
    }

    .pagefind-ui__search-input {
        color: #353333 !important;
    }

    .pagefind-ui__search-clear {
        color: #000000 !important;
    }

    /* Additional tweaking */
    .pagefind-ui__result {
        border-color: var(--pagefind-ui-border) !important;
    }

    .pagefind-ui__drawer {
        overflow-y: auto;
        max-height: calc(90vh - 80px);
        padding: 0 1rem 1rem 1rem;
    }

    .pagefind-ui__form:before {
        background-color: #000000 !important;
    }
</style>