{{ define "main" }}
<div class="max-w-7xl mx-auto p-6 min-h-screen">
    <!-- Grid Layout: 1 col mobile, 4 cols desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-x-8 lg:gap-y-4">

        <!-- Block 3: Results (Bottom Left on Desktop) -->
        <div class="lg:col-span-3">
            <!-- Header -->
            <div class="mb-6">
                {{ partial "breadcrumbs.html" . }}
                <!-- Search Toolbar -->
                {{ partial "search-toolbar.html" . }}
            </div>

            <!-- Worksheets Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {{ $paginator := .Paginate .RegularPages 10 }}
                {{ range $paginator.Pages }}
                <a href="{{ .RelPermalink }}" data-class="{{ .Params.class }}" data-subject="{{ .Params.subject }}"
                    class="card !p-4 group flex flex-col h-full hover:shadow-xl hover:shadow-emerald-500/5 dark:hover:shadow-emerald-900/10 hover:-translate-y-1 border-t-4 border-t-emerald-500">

                    <div class="flex items-start justify-between mb-3">
                        <div
                            class="p-2 rounded-lg bg-emerald-50 text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                <polyline points="14 2 14 8 20 8" />
                                <path d="M12 18v-6" />
                                <path d="M8 15h8" />
                            </svg>
                        </div>
                        {{ with .Date }}
                        <span
                            class="text-[10px] uppercase tracking-wide font-medium text-muted-foreground bg-muted px-2 py-0.5 rounded-full">
                            {{ .Format "Jan 2, 2006" }}
                        </span>
                        {{ end }}
                    </div>

                    <h3
                        class="text-lg font-bold text-main mb-2 group-hover:text-emerald-600 transition-colors line-clamp-2 leading-tight">
                        {{ .Title }}
                    </h3>

                    <p class="text-muted-foreground text-xs line-clamp-2 mb-4 flex-grow leading-relaxed">
                        {{ .Description | default .Summary }}
                    </p>

                    <div
                        class="flex items-center justify-between mt-auto pt-3 border-t border-dashed border-gray-200 dark:border-gray-800">
                        <span
                            class="text-[10px] font-bold text-muted-foreground uppercase tracking-widest">Worksheet</span>

                        <div class="flex items-center gap-2">
                            <button onclick="handleShare(this)"
                                class="share-btn p-1.5 rounded-full cursor-pointer hover:bg-blue-500/10 transition-colors text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400"
                                data-title="{{ .Title }}" data-url="{{ .Permalink }}" title="Share">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="18" cy="5" r="3"></circle>
                                    <circle cx="6" cy="12" r="3"></circle>
                                    <circle cx="18" cy="19" r="3"></circle>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                </svg>
                            </button>

                            <span
                                class="flex items-center text-xs font-semibold text-emerald-600 dark:text-emerald-400 group-hover:underline">
                                View
                                <svg class="w-3.5 h-3.5 ml-1 transition-transform group-hover:translate-x-1"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                    <polyline points="12 5 19 12 12 19" />
                                </svg>
                            </span>
                        </div>
                    </div>
                </a>
                {{ end }}
            </div>

            <!-- Pagination -->
            {{ partial "pagination.html" . }}
        </div>

        <!-- Mobile Filter Backdrop -->
        <div id="filter-backdrop" onclick="closeFilterDrawer()"
            class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity opacity-0 lg:hidden touch-none">
        </div>

        <!-- Block 2: Sidebar (Fixed alignment) -->
        <aside id="filter-drawer"
            class="fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-zinc-950 rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out lg:translate-y-0 lg:static lg:z-0 lg:shadow-none lg:bg-transparent lg:dark:bg-transparent lg:p-0 lg:col-span-1 lg:row-span-2 lg:h-fit lg:col-start-4 lg:row-start-1 max-h-[85vh] flex flex-col lg:block overscroll-contain">

            <!-- Drag Handle (Mobile Only) -->
            <div id="drawer-handle"
                class="w-full p-4 flex justify-center items-center cursor-grab active:cursor-grabbing lg:hidden touch-none">
                <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full"></div>
            </div>

            <!-- Content Container -->
            <div class="p-6 pt-0 overflow-y-auto lg:p-0">
                <!-- Mobile Header Title (Optional, keeping it clean for now or adding back if needed) -->
                <h3 class="text-lg font-bold mb-6 lg:hidden">Filters</h3>

                <div class="sticky top-24 space-y-8">
                    {{ partial "sidebar-filter.html" . }}
                </div>
            </div>
        </aside>

    </div>
</div>

<script>
    const drawer = document.getElementById('filter-drawer');
    const backdrop = document.getElementById('filter-backdrop');
    const handle = document.getElementById('drawer-handle');
    let startY = 0;
    let currentY = 0;
    let isDragging = false;
    let drawerHeight = 0;
    let isClosingCandidate = false;

    function openFilterDrawer() {
        drawer.classList.remove('translate-y-full');
        drawer.style.transform = ''; // Clear any manual transforms
        backdrop.classList.remove('hidden');
        setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden'; // Lock html
    }

    function closeFilterDrawer() {
        drawer.classList.add('translate-y-full');
        drawer.style.transform = ''; // Clear any manual transforms
        backdrop.classList.add('opacity-0');
        setTimeout(() => backdrop.classList.add('hidden'), 300);
        document.body.style.overflow = '';
        document.documentElement.style.overflow = ''; // Unlock html
    }

    function toggleFilterDrawer() {
        if (drawer.classList.contains('translate-y-full')) {
            openFilterDrawer();
        } else {
            closeFilterDrawer();
        }
    }

    // Touch Event Handlers for Swipe
    if (handle) {
        handle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            drawerHeight = drawer.offsetHeight;
            isClosingCandidate = false; // Reset state
            drawer.classList.remove('transition-transform', 'duration-300'); // Disable transition during drag
        }, { passive: true });

        handle.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;

            // Only allow dragging down
            if (diff > 0) {
                drawer.style.transform = `translateY(${diff}px)`;

                // Haptic Feedback Logic
                const threshold = drawerHeight * 0.3;
                const matchesClosing = diff > threshold;

                if (matchesClosing !== isClosingCandidate) {
                    // Crossed threshold
                    if (navigator.vibrate) navigator.vibrate(50); // Stronger tick
                    isClosingCandidate = matchesClosing;
                }
            }
        }, { passive: true });

        handle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            drawer.classList.add('transition-transform', 'duration-300'); // Re-enable transition

            const diff = currentY - startY;
            const threshold = drawerHeight * 0.3; // Close if dragged more than 30%

            if (diff > threshold) {
                closeFilterDrawer();
            } else {
                // Snap back to open
                drawer.style.transform = '';
            }
            startY = 0;
            currentY = 0;
        });
    }

    (function () {
        if (typeof window.handleShare !== 'function') {
            window.handleShare = async function (btn) {
                // Prevent the click from propagating to the parent link
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                const data = btn.dataset;
                const shareData = {
                    title: data.title,
                    url: data.url
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(shareData.url);

                        // Visual feedback for copy
                        const icon = btn.querySelector('svg');
                        const originalInner = btn.innerHTML;

                        // temporary check icon
                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="green" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

                        setTimeout(() => {
                            btn.innerHTML = originalInner;
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Error sharing:', err);
                }
            };
        }
    })();
</script>
{{ end }}